
# Introducción

```{r}
# INSTALAR LIBRERÍAS
#install.packages("shiny")
#install.packages("DT")
 


```


```{r}
# LIBRERÍAS
library(shiny)
library(DT)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(here)
library(readxl)
#

```


```{r}
# DATOS
#here()
# Datos limpios sobre precio de casas
datos <- read_excel(here("Shiny_Proyecto","app","datos_limpios.xlsx"))
datos



```







```{r}


# CORRECTO

# Colores personalizados para el gráfico de municipios
colores_personalizados <- c(
  "Municipio_A" = "red", "Municipio_B" = "blue", "Municipio_C" = "green",
  "Municipio_CH" = "purple", "Municipio_D" = "orange", "Municipio_E" = "pink",
  "Municipio_F" = "brown", "Municipio_G" = "cyan"
)

# UI
ui <- fluidPage(    # Página en blanco
  titlePanel("Análisis de Alquileres"),   # Título 
  sidebarLayout(             # Definimos la estructura
    sidebarPanel(            # Lo usamos para colocar los selectInput
      conditionalPanel(      # Panel condicional
        condition = "input.tabselected == 1",  # Este panel estara en la pestaña 1, que es la "Datos1" , donde se mostrara con dos botones que son "Seleccione el eje X:" y "Actualizar Gráfico"
        selectInput("x_axis_datos1", "Seleccione el eje X:", # Boton con opciones seleccionables (que seran distintos ejes X) y el nombre de este boton.
                    choices = list(        # Opciones a elegir (todas en relación al eje X)
                      "Baños" = "baños",
                      "Habitaciones" = "cant_habitaciones",
                      "Disposición" = "disposicion",
                      "Cuartos" = "cant_cuartos",
                      "Garages" = "cant_de_est")),
        actionButton("update_datos1", "Actualizar Gráficos") # Boton de acción para mostrar el gráfico
      ),
      conditionalPanel(  # Panel Condicional
        condition = "input.tabselected == 2", # Este panel estara en la pestaña 2, que es la "Datos2" , donde se mostrara con dos botones que son "Seleccione el eje X:" y "Actualizar Gráfico"
        selectInput("x_axis_datos2", "Seleccione el eje X:", # Boton con opciones seleccionables (que seran distintos ejes X) y el nombre de este boton.
                    choices = list( # Opciones a seleccionar
                                   "Metros Cuadrados por Construcción" = "m2_const", 
                                   "Metros por Terraza" = "m2_terraza",
                                   "Metros Cuadrados por Tierra" = "m2_totales")),
        actionButton("update_datos2", "Actualizar Gráficos") # Boton de acción para mostrar el gráfico
      ),
      conditionalPanel(  # Panel Condicional
        condition = "input.tabselected == 4", # Este panel estara en la pestaña 4, que es la "Gastos Comúnes" , donde se mostrara con dos botones que son "Seleccione el eje X para los gráficos de Gastos Comunes" y "Actualizar Gráfico"
        selectInput("x_axis_gastos", "Seleccione el eje X para los gráficos de Gastos Comunes:", # Boton con opciones seleccionables (que seran distintos ejes X) y el nombre de este boton.
                    choices = list( # Opciones a seleccionar
                      "Tipo de Propiedad" = "tipo_prop",
                      "Disposición" = "disposicion",
                      "Condición" = "Condicion",
                      "Municipio" = "Municipio")),
        actionButton("update_gastos", "Actualizar Gráficos") # Boton de acción para mostrar el gráfico
      ),
      conditionalPanel( # Panel Condicional
        condition = "input.tabselected == 6",  #  Este panel estara en la pestaña 6, que es la "Municipio" , donde se mostrara con dos botones que son "Seleccione el eje X:" y "Actualizar Gráfico"
        selectInput("x_axis_municipio", "Seleccione el eje X:", #  Boton con opciones seleccionables (que seran distintos ejes X) y el nombre de este boton.
                    choices = list( #  Opciones a seleccionar
                      "Zona" = "zona",
                      "Tipo de Propiedad" = "tipo_prop",
                      "Condición" = "Condicion")),
        actionButton("update_municipio", "Actualizar Gráficos") # Boton de acción para mostrar el gráfico
      ),
      conditionalPanel( # Panel Condicional
        condition = "input.tabselected == 7",  #  Este panel estara en la pestaña 7, que es la "Básicos" , donde se mostrara con dos botones que son "Seleccione el eje X:" y "Actualizar Gráfico"
        selectInput("x_axis_basicos", "Seleccione el eje X:", #  Boton con opciones seleccionables (que seran distintos ejes X) y el nombre de este boton.
                    choices = list( #  Opciones a seleccionar
                      "Municipio" = "Municipio",
                      "Tipo de Propiedad" = "tipo_prop",
                      "Condición" = "Condicion")),
        actionButton("update_basicos", "Actualizar Gráficos") # Boton de acción para mostrar el gráfico
      )
    ), 
    mainPanel( # Panel para las pestañas
      tabsetPanel(id = "tabselected",               #  id para la selección de pestañas
                  
                  tabPanel("Datos1",                  # Nombre de la pestaña
                           h2("Gráfico de Datos1"),   # Título de el gráfico dentro de esa pestaña
                           plotOutput("barPlot"),     # Gráfico en esa pestaña
                           value = 1                  # Le asociamos el valor de 1 para el gráfico y la reactividad
                  ),
                  tabPanel("Datos2",                  # Nombre de la pestaña
                           h2("Gráfico de Datos2"),   # Título de el gráfico dentro de esa pestaña
                           plotOutput("scatterPlot"), # Gráfico en esa pestaña
                           value = 2                  # Le asociamos el valor de 2 para el gráfico y la reactividad
                  ),
                  tabPanel("Mapa",                    # Nombre de la pestaña
                           h2("Gráfico de Mapa"),     # Título de el gráfico dentro de esa pestaña
                           value = 3                  # Le asociamos el valor de 3 para el gráfico y la reactividad
                  ), 
                  tabPanel("Gastos Comunes",                # Nombre de la pestaña
                           h2("Gráfico de Gastos Comunes"), # Título de el gráfico dentro de esa pestaña
                           plotOutput("gastosPlot1"),       # Gráfico en esa pestaña
                           value = 4                  # Le asociamos el valor de 4 para el gráfico y la reactividad
                  ),
                  tabPanel("Bernoulli",                     # Nombre de la pestaña
                           h2("Gráfico de Bernoulli"),      # Título de el gráfico dentro de esa pestaña
                           plotOutput("bernoulliPlot"),     # Gráfico en esa pestaña
                           value = 5                 # Le asociamos el valor de 5 para el gráfico y la reactividad
                  ),
                  tabPanel("Municipio",                     # Nombre de la pestaña
                           h2("Gráficos por Municipio"),    # Título de el gráfico dentro de esa pestaña
                           plotOutput("municipioPlot1"),    # Gráfico en esa pestaña
                           value = 6                   # Le asociamos el valor de 6 para el gráfico y la reactividad
                  ),
                                    tabPanel("Basicos",     # Nombre de la pestaña
                           h2("Gráficos Básicos"),          # Título de el gráfico dentro de esa pestaña
                           plotOutput("BasicosPlot"),       # Gráfico en esa pestaña
                           value = 7                  # Le asociamos el valor de 7 para el gráfico y la reactividad
                  )
      )
    )
  )
)

# Server
server <- function(input, output, session) {  # Definimos el server

  observeEvent(input$update_datos1, {
    output$barPlot <- renderPlot({
      x_axis <- input$x_axis_datos1
      if (x_axis == "disposicion") {
        p1 <- ggplot(datos, aes(x = disposicion)) +
          geom_bar() +
          labs(x = "Disposición", y = "Cantidad")

        
         Prueba20 <- datos %>%     
         group_by(disposicion) %>% 
         summarise(media_precio = mean(precio)) 
         Prueba20
        
        p2 <- ggplot(Prueba20, aes(x = disposicion, y = media_precio)) +
          geom_bar(stat = "identity") +
          labs(x = "Disposición", y = "Media Precio")

        gridExtra::grid.arrange(p1, p2, nrow = 2)
      } else {
        datos_resumidos <- datos %>%
          group_by(across(all_of(x_axis))) %>%
          summarise(media_precio = mean(precio, na.rm = TRUE), .groups = 'drop')

        p1 <- ggplot(datos, aes_string(x = x_axis)) +
          geom_bar() +
          scale_x_continuous(breaks = unique(datos[[x_axis]])) +
          labs(x = x_axis, y = "Cantidad")

        p2 <- ggplot(datos_resumidos, aes_string(x = x_axis, y = "media_precio")) +
          geom_bar(stat = "identity") +
          scale_x_discrete(breaks = unique(datos_resumidos[[x_axis]])) +
          labs(x = x_axis, y = "Media Precio")

        gridExtra::grid.arrange(p1, p2, nrow = 2)
      }
    })
  })

  observeEvent(input$update_datos2, {
    output$scatterPlot <- renderPlot({
      x_axis <- input$x_axis_datos2
      datos_2 <- datos %>% select(all_of(c(x_axis, "precio")))
      ggplot(datos_2, aes_string(x = x_axis, y = "precio")) +
        geom_point() +
        labs(x = x_axis, y = "Precio") +
        theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1, size = 8))
    })
  })

  observeEvent(input$update_gastos, {
    output$gastosPlot1 <- renderPlot({
      x_axis <- input$x_axis_gastos
      ggplot(datos, aes_string(x = x_axis, y = "Gastos_Comunes")) +
        geom_bar(stat="identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1))
    })
  })
  
  
  observe({
    output$bernoulliPlot <- renderPlot({
      dum <- datos %>%
        select("vista_al_mar", "vivienda_social", "Barbecue",                           "Living_Room", "Closet", "Patio", "Pool", "Garage",                     "Pet", "coneccion_cas", "Playroom", "Duplex",                           "calefaccion", "WiFi", "zona_barbacoa", "Gym", "balcon",                  "deposito", "Air_Conditioning", "jardin",                                "losa_radiante", "Solarium", "amueblado")
      
      calcular_y_unir <- function(df, col, resultado_final) { # Función
       temp <- df %>%       # Datos
        group_by(valor = .data[[col]]) %>% #
       summarise(Mean = mean(precio, na.rm = TRUE), .groups = "drop")
       colnames(temp)[2] <- paste0(col, "_Media") 
       resultado_final <- left_join(resultado_final, temp, by = "valor",        relationship = "many-to-one") 
       return(resultado_final) # Resultado
        }

      resultado_final <- data.frame(valor = c(0, 1))
      columnas <- colnames(dum)
      for (col in columnas) {
        resultado_final <- calcular_y_unir(datos, col, resultado_final)
      }
      data_long <- resultado_final %>%
        pivot_longer(-valor, names_to = "variable", values_to = "value")
      ggplot(data_long, aes(x = variable, y = value, fill = as.factor(valor))) + 
        geom_bar(stat = "identity", position = position_dodge(width = 0.5)) +  
        labs(x = "Variable", y = "Value", fill = "Value") + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1))
    })
  })
  
  
  

  observeEvent(input$update_municipio, {
    output$municipioPlot1 <- renderPlot({
      x_axis <- input$x_axis_municipio
      ggplot(datos, aes_string(x = x_axis, y = "precio", fill = "Municipio")) +
        geom_bar(stat = "identity", position = "dodge", width = 0.7) +
        facet_grid(. ~ Municipio, scales = "free_x") +
        labs(x = x_axis, y = "Precio", fill = "Municipio") +
        ggtitle("Precio por Municipio") +
        scale_fill_manual(values = colores_personalizados) +
        theme(plot.title = element_text(hjust = 0.5),
              axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
    })
  })
  
  
  
  
observeEvent(input$update_basicos, {
    output$BasicosPlot <- renderPlot({
      x_axis <- input$x_axis_basicos
      datos_resumidos <- datos %>%
        group_by(across(all_of(x_axis))) %>%
        summarise(Cantidad = n(), .groups = 'drop')

      ggplot(datos_resumidos, aes_string(x = x_axis, y = "Cantidad")) +
        geom_bar(stat = "identity") +
        labs(x = x_axis, y = "Cantidad") +
        theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1, size = 8))
    })
  })
  
  
}

shinyApp(ui = ui, server = server)



``` 

